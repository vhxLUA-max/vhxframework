local Players      = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UIS          = game:GetService("UserInputService")
local HttpService  = game:GetService("HttpService")
local RunService   = game:GetService("RunService")
local LocalPlayer  = Players.LocalPlayer

local NightLib        = {}
NightLib.__index      = NightLib
NightLib.Flags        = {}
NightLib._configCache = {}
NightLib._profile     = "Default"

local function _filePath(p) return "NightLib_"..(p or NightLib._profile)..".json" end

function NightLib:SaveConfig(profile)
    profile = profile or self._profile
    local data = {}
    for flag, obj in pairs(self.Flags) do
        local v = obj:Get()
        if typeof(v) == "Color3" then data[flag] = {__color3=true, r=v.R, g=v.G, b=v.B}
        else data[flag] = v end
    end
    self._configCache[profile] = data
    local ok, err = pcall(writefile, _filePath(profile), HttpService:JSONEncode(data))
    if not ok then warn("NightLib: SaveConfig -", err) end
end

function NightLib:LoadConfig(profile)
    profile = profile or self._profile
    if self._configCache[profile] then return self._configCache[profile] end
    local ok, raw = pcall(readfile, _filePath(profile))
    if not ok or not raw or raw == "" then return {} end
    local ok2, data = pcall(function() return HttpService:JSONDecode(raw) end)
    if not ok2 then return {} end
    for k, v in pairs(data) do
        if type(v) == "table" and v.__color3 then data[k] = Color3.new(v.r, v.g, v.b) end
    end
    self._configCache[profile] = data
    return data
end

function NightLib:SetProfile(p) self._profile = p; self:LoadConfig(p) end

function NightLib:ApplyProfile(profile)
    local data = self:LoadConfig(profile)
    for flag, val in pairs(data) do
        if self.Flags[flag] then self.Flags[flag]:Set(val) end
    end
end

local function _autoSave(flag, val)
    local p = NightLib._profile
    if not NightLib._configCache[p] then NightLib._configCache[p] = {} end
    if typeof(val) == "Color3" then
        NightLib._configCache[p][flag] = {__color3=true, r=val.R, g=val.G, b=val.B}
    else NightLib._configCache[p][flag] = val end
    local ok, err = pcall(writefile, _filePath(p), HttpService:JSONEncode(NightLib._configCache[p]))
    if not ok then warn("NightLib: AutoSave -", err) end
end

local function _saved(flag, fallback)
    if not flag then return fallback end
    local data = NightLib._configCache[NightLib._profile]
    if data and data[flag] ~= nil then return data[flag] end
    return fallback
end

local Themes = {
    Dark = {
        Background    = Color3.fromRGB(24,24,28),    Sidebar       = Color3.fromRGB(18,18,22),
        Panel         = Color3.fromRGB(32,32,38),    PanelAlt      = Color3.fromRGB(38,38,46),
        Accent        = Color3.fromRGB(100,180,255), AccentAlt     = Color3.fromRGB(220,100,100),
        TextPrimary   = Color3.fromRGB(240,240,245), TextSecondary = Color3.fromRGB(140,140,155),
        Divider       = Color3.fromRGB(45,45,55),    ToggleOn      = Color3.fromRGB(80,200,120),
        ToggleOff     = Color3.fromRGB(60,60,72),    NotifyBg      = Color3.fromRGB(30,80,160),
    },
    Midnight = {
        Background    = Color3.fromRGB(10,10,18),    Sidebar       = Color3.fromRGB(8,8,14),
        Panel         = Color3.fromRGB(18,18,30),    PanelAlt      = Color3.fromRGB(24,24,40),
        Accent        = Color3.fromRGB(140,100,255), AccentAlt     = Color3.fromRGB(255,80,140),
        TextPrimary   = Color3.fromRGB(230,225,255), TextSecondary = Color3.fromRGB(120,115,150),
        Divider       = Color3.fromRGB(30,30,50),    ToggleOn      = Color3.fromRGB(140,100,255),
        ToggleOff     = Color3.fromRGB(40,40,60),    NotifyBg      = Color3.fromRGB(60,30,120),
    },
    Light = {
        Background    = Color3.fromRGB(240,240,248), Sidebar       = Color3.fromRGB(225,225,235),
        Panel         = Color3.fromRGB(255,255,255), PanelAlt      = Color3.fromRGB(248,248,252),
        Accent        = Color3.fromRGB(60,130,220),  AccentAlt     = Color3.fromRGB(200,60,80),
        TextPrimary   = Color3.fromRGB(20,20,30),    TextSecondary = Color3.fromRGB(100,100,120),
        Divider       = Color3.fromRGB(210,210,225), ToggleOn      = Color3.fromRGB(50,180,100),
        ToggleOff     = Color3.fromRGB(190,190,205), NotifyBg      = Color3.fromRGB(40,100,200),
    },
    Aqua = {
        Background    = Color3.fromRGB(12,22,30),    Sidebar       = Color3.fromRGB(8,16,24),
        Panel         = Color3.fromRGB(18,32,44),    PanelAlt      = Color3.fromRGB(22,40,54),
        Accent        = Color3.fromRGB(0,200,200),   AccentAlt     = Color3.fromRGB(0,255,180),
        TextPrimary   = Color3.fromRGB(220,245,255), TextSecondary = Color3.fromRGB(100,160,185),
        Divider       = Color3.fromRGB(20,50,70),    ToggleOn      = Color3.fromRGB(0,200,200),
        ToggleOff     = Color3.fromRGB(25,50,65),    NotifyBg      = Color3.fromRGB(0,80,100),
    },
    Rose = {
        Background    = Color3.fromRGB(20,12,16),    Sidebar       = Color3.fromRGB(14,8,12),
        Panel         = Color3.fromRGB(30,18,24),    PanelAlt      = Color3.fromRGB(38,22,30),
        Accent        = Color3.fromRGB(255,80,140),  AccentAlt     = Color3.fromRGB(255,150,80),
        TextPrimary   = Color3.fromRGB(255,230,240), TextSecondary = Color3.fromRGB(160,110,130),
        Divider       = Color3.fromRGB(55,28,40),    ToggleOn      = Color3.fromRGB(255,80,140),
        ToggleOff     = Color3.fromRGB(55,28,40),    NotifyBg      = Color3.fromRGB(120,20,60),
    },
}

local function Tween(obj, props, dur, style, dir)
    TweenService:Create(obj, TweenInfo.new(dur or 0.2, style or Enum.EasingStyle.Quad,
        dir or Enum.EasingDirection.Out), props):Play()
end

local function New(class, props, parent)
    local obj = Instance.new(class)
    for k, v in pairs(props or {}) do obj[k] = v end
    if parent then obj.Parent = parent end
    return obj
end

local function MakeDraggable(frame, handle)
    handle = handle or frame
    local dragging, dragStart, startPos
    handle.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = i.Position; startPos = frame.Position
        end
    end)
    handle.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    UIS.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X,
                startPos.Y.Scale, startPos.Y.Offset + d.Y)
        end
    end)
end

local Icons = {
    home="âŒ‚",settings="âš™",user="ðŸ‘¤",star="â˜…",bell="ðŸ””",code="</>",map="â—‰",shield="â—ˆ",zap="âš¡",
    eye="â—Ž",lock="ðŸ”’",key="ðŸ”‘",trash="ðŸ—‘",copy="âŽ˜",download="â†“",upload="â†‘",search="âŒ•",plus="+",
    minus="âˆ’",check="âœ“",x="x",arrow_right="â†’",arrow_left="â†",refresh="â†»",wifi="â—Œ",globe="â—‰",
    server="â–£",cpu="â¬š",database="â¬¡",layers="â¬œ",terminal=">_",sword="âš”",gamepad="ðŸŽ®",flag="âš‘",
    heart="â™¥",info="â„¹",alert="âš ",chart="ðŸ“Š",list="â˜°",grid="âŠž",folder="ðŸ“",paint="ðŸŽ¨",
    pin="ðŸ“Œ",cursor="â—ˆ",fire="ðŸ”¥",crown="â™›",diamond="â—†",moon="â˜½",sun="â˜€",cloud="â˜",
}
local function GetIcon(n) return Icons[n and n:lower()] or "â—" end

NightLib:LoadConfig("Default")

function NightLib:CreateWindow(config)
    config = config or {}
    local Title = config.Title    or "NightLib"
    local Sub   = config.Subtitle or ""
    local Theme = Themes[config.Theme or "Dark"] or Themes.Dark

    if config.Profile then self:SetProfile(config.Profile) end

    local ok, cg = pcall(function() return game:GetService("CoreGui") end)
    local SG = New("ScreenGui", {
        Name="NightLib_"..Title, ResetOnSpawn=false,
        ZIndexBehavior=Enum.ZIndexBehavior.Sibling,
    }, (ok and cg) or LocalPlayer.PlayerGui)

    local MF = New("Frame", {
        Size=UDim2.new(0,680,0,460), Position=UDim2.new(0.5,-340,0.5,-230),
        BackgroundColor3=Theme.Background, BorderSizePixel=0, ClipsDescendants=true,
    }, SG)
    New("UICorner", {CornerRadius=UDim.new(0,10)}, MF)
    New("UIStroke", {Color=Theme.Divider, Thickness=1}, MF)
    New("ImageLabel", {
        Size=UDim2.new(1,40,1,40), Position=UDim2.new(0,-20,0,-20),
        BackgroundTransparency=1, Image="rbxassetid://5554236805",
        ImageColor3=Color3.new(), ImageTransparency=0.6, ZIndex=0,
        ScaleType=Enum.ScaleType.Slice, SliceCenter=Rect.new(23,23,277,277),
    }, MF)

    local TB = New("Frame", {Size=UDim2.new(1,0,0,48), BackgroundColor3=Theme.Sidebar, BorderSizePixel=0, ZIndex=2}, MF)
    local LF = New("Frame", {Size=UDim2.new(0,32,0,32), Position=UDim2.new(0,10,0.5,-16), BackgroundColor3=Theme.Accent, ZIndex=3}, TB)
    New("UICorner", {CornerRadius=UDim.new(0,8)}, LF)
    New("TextLabel", {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text="â—‘", TextColor3=Color3.new(1,1,1), TextSize=18, Font=Enum.Font.GothamBold, ZIndex=4}, LF)
    New("TextLabel", {Size=UDim2.new(0,200,0,22), Position=UDim2.new(0,50,0,7), BackgroundTransparency=1, Text=Title, TextColor3=Theme.TextPrimary, TextSize=15, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=3}, TB)
    New("TextLabel", {Size=UDim2.new(0,200,0,16), Position=UDim2.new(0,50,0,28), BackgroundTransparency=1, Text=Sub, TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.Gotham, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=3}, TB)

    local CB = New("TextButton", {Size=UDim2.new(0,28,0,28), Position=UDim2.new(1,-38,0.5,-14), BackgroundColor3=Color3.fromRGB(200,60,60), Text="âœ•", TextColor3=Color3.new(1,1,1), TextSize=12, Font=Enum.Font.GothamBold, ZIndex=3}, TB)
    New("UICorner", {CornerRadius=UDim.new(0,6)}, CB)
    CB.MouseButton1Click:Connect(function()
        Tween(MF, {Position=UDim2.new(0.5,-340,1.2,0)}, 0.3); task.wait(0.35); SG:Destroy()
    end)

    local MinB = New("TextButton", {Size=UDim2.new(0,28,0,28), Position=UDim2.new(1,-72,0.5,-14), BackgroundColor3=Theme.PanelAlt, Text="â€“", TextColor3=Theme.TextSecondary, TextSize=14, Font=Enum.Font.GothamBold, ZIndex=3}, TB)
    New("UICorner", {CornerRadius=UDim.new(0,6)}, MinB)
    local mini = false
    MinB.MouseButton1Click:Connect(function()
        mini = not mini
        Tween(MF, {Size=mini and UDim2.new(0,680,0,48) or UDim2.new(0,680,0,460)}, 0.25)
    end)
    MakeDraggable(MF, TB)

    local SB = New("Frame", {Size=UDim2.new(0,54,1,-48), Position=UDim2.new(0,0,0,48), BackgroundColor3=Theme.Sidebar, BorderSizePixel=0, ZIndex=2}, MF)
    New("UIListLayout", {FillDirection=Enum.FillDirection.Vertical, SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,4)}, SB)
    New("UIPadding", {PaddingTop=UDim.new(0,10), PaddingBottom=UDim.new(0,10), PaddingLeft=UDim.new(0,7), PaddingRight=UDim.new(0,7)}, SB)
    New("Frame", {Size=UDim2.new(0,1,1,-48), Position=UDim2.new(0,54,0,48), BackgroundColor3=Theme.Divider, BorderSizePixel=0, ZIndex=2}, MF)

    local CA = New("Frame", {Size=UDim2.new(1,-55,1,-48), Position=UDim2.new(0,55,0,48), BackgroundTransparency=1, BorderSizePixel=0, ZIndex=2, ClipsDescendants=true}, MF)
    local NC = New("Frame", {Size=UDim2.new(0,260,1,0), Position=UDim2.new(1,-270,0,0), BackgroundTransparency=1, ZIndex=10}, CA)
    New("UIListLayout", {FillDirection=Enum.FillDirection.Vertical, VerticalAlignment=Enum.VerticalAlignment.Bottom, SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,6)}, NC)
    New("UIPadding", {PaddingBottom=UDim.new(0,10), PaddingRight=UDim.new(0,8)}, NC)

    local WO  = {Theme=Theme, Tabs={}}
    local visible = true
    local keys = {toggle = config.ToggleKey or Enum.KeyCode.RightControl}

    function WO:SetVisible(s) visible = s; MF.Visible = s end
    function WO:GetVisible() return visible end
    function WO:Destroy() SG:Destroy() end
    function WO:SetToggleKey(k) keys.toggle = k end
    function WO:GetToggleKey() return keys.toggle end

    function WO:SetTheme(themeName)
        local t = Themes[themeName]
        if not t then return end
        Theme = t
        WO.Theme = t
    end

    UIS.InputBegan:Connect(function(i, gpe)
        if not gpe and i.KeyCode == keys.toggle then WO:SetVisible(not visible) end
    end)

    function WO:Notify(cfg)
        cfg = cfg or {}
        local dur = cfg.Duration or 4
        local N = New("Frame", {Size=UDim2.new(1,0,0,64), BackgroundColor3=cfg.Color or Theme.NotifyBg, BorderSizePixel=0, BackgroundTransparency=1, ZIndex=11}, NC)
        New("UICorner", {CornerRadius=UDim.new(0,8)}, N)
        New("TextLabel", {Size=UDim2.new(1,-16,0,20), Position=UDim2.new(0,12,0,8), BackgroundTransparency=1, Text=cfg.Title or "Notification", TextColor3=Color3.new(1,1,1), TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=12}, N)
        New("TextLabel", {Size=UDim2.new(1,-16,0,30), Position=UDim2.new(0,12,0,28), BackgroundTransparency=1, Text=cfg.Message or "", TextColor3=Color3.fromRGB(200,210,230), TextSize=11, Font=Enum.Font.Gotham, TextWrapped=true, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=12}, N)
        local PB = New("Frame", {Size=UDim2.new(1,0,0,3), Position=UDim2.new(0,0,1,-3), BackgroundColor3=Color3.new(1,1,1), BackgroundTransparency=0.6, BorderSizePixel=0, ZIndex=13}, N)
        New("UICorner", {CornerRadius=UDim.new(0,2)}, PB)
        Tween(N, {BackgroundTransparency=0.1}, 0.3)
        Tween(PB, {Size=UDim2.new(0,0,0,3)}, dur, Enum.EasingStyle.Linear)
        task.delay(dur, function() Tween(N, {BackgroundTransparency=1}, 0.3); task.wait(0.3); N:Destroy() end)
    end

    function WO:Dialog(cfg)
        cfg = cfg or {}
        local overlay = New("Frame", {Size=UDim2.new(1,0,1,0), BackgroundColor3=Color3.new(0,0,0), BackgroundTransparency=0.5, ZIndex=50}, MF)
        local DB = New("Frame", {Size=UDim2.new(0,320,0,160), Position=UDim2.new(0.5,-160,0.5,-80), BackgroundColor3=Theme.Panel, BorderSizePixel=0, ZIndex=51}, overlay)
        New("UICorner", {CornerRadius=UDim.new(0,10)}, DB)
        New("UIStroke", {Color=Theme.Accent, Thickness=1}, DB)
        New("TextLabel", {Size=UDim2.new(1,-20,0,30), Position=UDim2.new(0,10,0,12), BackgroundTransparency=1, Text=cfg.Title or "Confirm", TextColor3=Theme.TextPrimary, TextSize=15, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=52}, DB)
        New("TextLabel", {Size=UDim2.new(1,-20,0,50), Position=UDim2.new(0,10,0,48), BackgroundTransparency=1, Text=cfg.Content or "", TextColor3=Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, TextWrapped=true, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=52}, DB)
        local btns = cfg.Buttons or {{Title="OK", Color=Theme.Accent, Callback=function() end}}
        local bW = (300 - (#btns-1)*8) / #btns
        for i, b in ipairs(btns) do
            local xPos = 10 + (i-1)*(bW+8)
            local BB = New("TextButton", {Size=UDim2.new(0,bW,0,30), Position=UDim2.new(0,xPos,1,-42), BackgroundColor3=b.Color or Theme.Accent, Text=b.Title or "OK", TextColor3=Color3.new(1,1,1), TextSize=13, Font=Enum.Font.GothamBold, ZIndex=52}, DB)
            New("UICorner", {CornerRadius=UDim.new(0,6)}, BB)
            BB.MouseButton1Click:Connect(function()
                overlay:Destroy()
                task.spawn(b.Callback or function() end)
            end)
        end
        DB.Position = UDim2.new(0.5,-160,0.3,-80)
        Tween(DB, {Position=UDim2.new(0.5,-160,0.5,-80)}, 0.3, Enum.EasingStyle.Back)
    end

    function WO:CreateTab(cfg)
        cfg = cfg or {}
        local tabTitle = cfg.Title or "Tab"
        local TBtn = New("TextButton", {Size=UDim2.new(1,0,0,38), BackgroundColor3=Theme.PanelAlt, BackgroundTransparency=1, Text="", ZIndex=3}, SB)
        New("UICorner", {CornerRadius=UDim.new(0,8)}, TBtn)
        local IL = New("TextLabel", {Size=UDim2.new(1,0,0,20), Position=UDim2.new(0,0,0,6), BackgroundTransparency=1, Text=GetIcon(cfg.Icon or "layers"), TextColor3=Theme.TextSecondary, TextSize=16, Font=Enum.Font.GothamBold, ZIndex=4}, TBtn)
        local TL = New("TextLabel", {Size=UDim2.new(1,0,0,12), Position=UDim2.new(0,0,0,26), BackgroundTransparency=1, Text=tabTitle:sub(1,5), TextColor3=Theme.TextSecondary, TextSize=9, Font=Enum.Font.Gotham, ZIndex=4}, TBtn)
        local AD = New("Frame", {Size=UDim2.new(0,3,0,28), Position=UDim2.new(0,-7,0.5,-14), BackgroundColor3=Theme.Accent, BackgroundTransparency=1, BorderSizePixel=0, ZIndex=4}, TBtn)
        New("UICorner", {CornerRadius=UDim.new(0,2)}, AD)

        local TF = New("ScrollingFrame", {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, BorderSizePixel=0, ScrollBarThickness=3, ScrollBarImageColor3=Theme.Accent, CanvasSize=UDim2.new(0,0,0,0), AutomaticCanvasSize=Enum.AutomaticSize.Y, Visible=false, ZIndex=2}, CA)
        New("UIPadding", {PaddingTop=UDim.new(0,10), PaddingLeft=UDim.new(0,10), PaddingRight=UDim.new(0,10), PaddingBottom=UDim.new(0,10)}, TF)
        New("UIListLayout", {FillDirection=Enum.FillDirection.Vertical, SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,8)}, TF)

        local function Activate()
            for _, t in pairs(WO.Tabs) do
                t.Frame.Visible = false
                Tween(t.BI, {TextColor3=Theme.TextSecondary}, 0.15)
                Tween(t.BA, {BackgroundTransparency=1}, 0.15)
                t.Btn.BackgroundTransparency = 1
            end
            TF.Visible = true
            Tween(IL, {TextColor3=Theme.Accent}, 0.15)
            Tween(TL, {TextColor3=Theme.Accent}, 0.15)
            Tween(AD, {BackgroundTransparency=0}, 0.15)
            TBtn.BackgroundTransparency = 0.85
        end
        TBtn.MouseButton1Click:Connect(Activate)
        TBtn.MouseEnter:Connect(function() if not TF.Visible then Tween(TBtn, {BackgroundTransparency=0.9}, 0.1) end end)
        TBtn.MouseLeave:Connect(function() if not TF.Visible then Tween(TBtn, {BackgroundTransparency=1}, 0.1) end end)
        table.insert(WO.Tabs, {Frame=TF, Btn=TBtn, BI=IL, BA=AD})
        if #WO.Tabs == 1 then Activate() end

        local TO = {}
        function TO:Select() Activate() end

        function TO:CreateSection(cfg)
            cfg = cfg or {}
            local SF = New("Frame", {Size=UDim2.new(1,0,0,0), AutomaticSize=Enum.AutomaticSize.Y, BackgroundColor3=Theme.Panel, BorderSizePixel=0, ZIndex=3}, TF)
            New("UICorner", {CornerRadius=UDim.new(0,8)}, SF)
            New("UIPadding", {PaddingTop=UDim.new(0,8), PaddingBottom=UDim.new(0,8), PaddingLeft=UDim.new(0,10), PaddingRight=UDim.new(0,10)}, SF)
            New("UIListLayout", {FillDirection=Enum.FillDirection.Vertical, SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,6)}, SF)
            local SH = New("Frame", {Size=UDim2.new(1,0,0,24), BackgroundTransparency=1, ZIndex=4, LayoutOrder=0}, SF)
            New("TextLabel", {Size=UDim2.new(1,-40,1,0), BackgroundTransparency=1, Text=cfg.Title or "Section", TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, SH)
            New("Frame", {Size=UDim2.new(1,0,0,1), Position=UDim2.new(0,0,1,-1), BackgroundColor3=Theme.Divider, BorderSizePixel=0, ZIndex=5}, SH)

            local SO = {}
            local ord = 1
            local function NO() ord = ord+1; return ord end

            function SO:CreateDivider(cfg)
                cfg = cfg or {}
                local d = New("Frame", {Size=UDim2.new(1,0,0,1), BackgroundColor3=cfg.Color or Theme.Divider, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                local o = {}
                function o:Update(c) Tween(d, {BackgroundColor3=c}, 0.2) end
                function o:Destroy() d:Destroy() end
                return o
            end

            function SO:CreateLabel(cfg)
                cfg = cfg or {}
                local LF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, LF)
                if cfg.Icon then
                    New("TextLabel", {Size=UDim2.new(0,24,0,24), Position=UDim2.new(0,8,0.5,-12), BackgroundTransparency=1, Text=GetIcon(cfg.Icon), TextColor3=Theme.Accent, TextSize=14, Font=Enum.Font.GothamBold, ZIndex=5}, LF)
                end
                local xOff = cfg.Icon and 36 or 10
                New("TextLabel", {Size=UDim2.new(0.45,-xOff,1,0), Position=UDim2.new(0,xOff,0,0), BackgroundTransparency=1, Text=cfg.Title or "Label", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, LF)
                local VL = New("TextLabel", {Size=UDim2.new(0.52,0,1,0), Position=UDim2.new(0.46,0,0,0), BackgroundTransparency=1, Text=tostring(cfg.Value or ""), TextColor3=cfg.Color or Theme.Accent, TextSize=12, Font=Enum.Font.Gotham, TextXAlignment=Enum.TextXAlignment.Right, TextTruncate=Enum.TextTruncate.AtEnd, ZIndex=5}, LF)
                New("UIPadding", {PaddingRight=UDim.new(0,10)}, VL)
                local obj = {}
                function obj:Set(v) VL.Text = tostring(v) end
                function obj:Get() return VL.Text end
                function obj:SetColor(c) VL.TextColor3 = c end
                return obj
            end

            function SO:CreateImage(cfg)
                cfg = cfg or {}
                local imgH  = cfg.Size or 72
                local totalH = imgH + (cfg.Title and 26 or 12)
                local IF = New("Frame", {Size=UDim2.new(1,0,0,totalH), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, IF)
                local yOff = 6
                if cfg.Title then
                    New("TextLabel", {Size=UDim2.new(1,-16,0,18), Position=UDim2.new(0,10,0,5), BackgroundTransparency=1, Text=cfg.Title, TextColor3=Theme.TextSecondary, TextSize=10, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, IF)
                    yOff = 24
                end
                local IL = New("ImageLabel", {
                    Size=UDim2.new(0,imgH,0,imgH), Position=UDim2.new(0.5,-imgH/2,0,yOff),
                    BackgroundTransparency=1, Image=cfg.Image or "", ScaleType=Enum.ScaleType.Fit, ZIndex=5,
                }, IF)
                if cfg.Circle then New("UICorner", {CornerRadius=UDim.new(0.5,0)}, IL) end
                New("UIStroke", {Color=Theme.Accent, Thickness=2, ApplyStrokeMode=Enum.ApplyStrokeMode.Border}, IL)
                local obj = {}
                function obj:Set(img) IL.Image = img end
                function obj:Get() return IL.Image end
                return obj
            end

            function SO:CreateButton(cfg)
                cfg = cfg or {}
                local BF = New("TextButton", {Size=UDim2.new(1,0,0,cfg.Description and 50 or 36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, Text="", ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, BF)
                if cfg.Icon then New("TextLabel", {Size=UDim2.new(0,24,0,24), Position=UDim2.new(0,8,0.5,-12), BackgroundTransparency=1, Text=GetIcon(cfg.Icon), TextColor3=Theme.Accent, TextSize=14, Font=Enum.Font.GothamBold, ZIndex=5}, BF) end
                local x = cfg.Icon and 36 or 10
                New("TextLabel", {Size=UDim2.new(1,-(x+40),0,20), Position=UDim2.new(0,x,cfg.Description and 0.15 or 0.5,-10), BackgroundTransparency=1, Text=cfg.Title or "Button", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, BF)
                if cfg.Description then New("TextLabel", {Size=UDim2.new(1,-(x+10),0,16), Position=UDim2.new(0,x,0,24), BackgroundTransparency=1, Text=cfg.Description, TextColor3=Theme.TextSecondary, TextSize=10, Font=Enum.Font.Gotham, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, BF) end
                New("TextLabel", {Size=UDim2.new(0,20,1,0), Position=UDim2.new(1,-26,0,0), BackgroundTransparency=1, Text="â€º", TextColor3=Theme.TextSecondary, TextSize=18, Font=Enum.Font.GothamBold, ZIndex=5}, BF)
                BF.MouseEnter:Connect(function() Tween(BF, {BackgroundColor3=Theme.Divider}, 0.1) end)
                BF.MouseLeave:Connect(function() Tween(BF, {BackgroundColor3=Theme.PanelAlt}, 0.1) end)
                BF.MouseButton1Click:Connect(function()
                    Tween(BF, {BackgroundColor3=Theme.Accent}, 0.05); task.wait(0.1)
                    Tween(BF, {BackgroundColor3=Theme.PanelAlt}, 0.15)
                    task.spawn(cfg.Callback or function() end)
                end)
                local obj = {_frame=BF}
                function obj:SetTitle(t) local l = BF:FindFirstChildWhichIsA("TextLabel"); if l then l.Text = t end end
                function obj:SetEnabled(e)
                    BF.Active = e
                    Tween(BF, {BackgroundTransparency=e and 0 or 0.5}, 0.15)
                end
                return obj
            end

            function SO:CreateToggle(cfg)
                cfg = cfg or {}
                local flag = cfg.Flag
                local cb   = cfg.Callback or function() end
                local val  = _saved(flag, cfg.Default or false)

                local TF2 = New("Frame", {Size=UDim2.new(1,0,0,cfg.Description and 50 or 36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, TF2)
                New("TextLabel", {Size=UDim2.new(1,-60,0,20), Position=UDim2.new(0,10,cfg.Description and 0.15 or 0.5,-10), BackgroundTransparency=1, Text=cfg.Title or "Toggle", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, TF2)
                if cfg.Description then New("TextLabel", {Size=UDim2.new(1,-60,0,16), Position=UDim2.new(0,10,0,24), BackgroundTransparency=1, Text=cfg.Description, TextColor3=Theme.TextSecondary, TextSize=10, Font=Enum.Font.Gotham, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, TF2) end

                local SBg  = New("Frame", {Size=UDim2.new(0,38,0,20), Position=UDim2.new(1,-48,0.5,-10), BackgroundColor3=val and Theme.ToggleOn or Theme.ToggleOff, BorderSizePixel=0, ZIndex=5}, TF2)
                New("UICorner", {CornerRadius=UDim.new(0,10)}, SBg)
                local Knob = New("Frame", {Size=UDim2.new(0,14,0,14), Position=val and UDim2.new(1,-17,0.5,-7) or UDim2.new(0,3,0.5,-7), BackgroundColor3=Color3.new(1,1,1), BorderSizePixel=0, ZIndex=6}, SBg)
                New("UICorner", {CornerRadius=UDim.new(0,7)}, Knob)
                New("TextButton", {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text="", ZIndex=7}, SBg)
                    .MouseButton1Click:Connect(function()
                        val = not val
                        Tween(SBg,  {BackgroundColor3=val and Theme.ToggleOn or Theme.ToggleOff}, 0.2)
                        Tween(Knob, {Position=val and UDim2.new(1,-17,0.5,-7) or UDim2.new(0,3,0.5,-7)}, 0.2)
                        if flag then _autoSave(flag, val) end
                        task.spawn(cb, val)
                    end)

                local tObj = {}
                function tObj:Set(v)
                    val = v
                    Tween(SBg,  {BackgroundColor3=v and Theme.ToggleOn or Theme.ToggleOff}, 0.2)
                    Tween(Knob, {Position=v and UDim2.new(1,-17,0.5,-7) or UDim2.new(0,3,0.5,-7)}, 0.2)
                    if flag then _autoSave(flag, v) end
                end
                function tObj:Get() return val end
                function tObj:SetTitle(t) local l = TF2:FindFirstChildWhichIsA("TextLabel"); if l then l.Text = t end end
                if flag then NightLib.Flags[flag] = tObj end
                return tObj
            end

            function SO:CreateSlider(cfg)
                cfg = cfg or {}
                local flag = cfg.Flag
                local cb   = cfg.Callback or function() end
                local sMin = cfg.Min or 0;  local sMax = cfg.Max or 100
                local suf  = cfg.Suffix or ""
                local dec  = cfg.Decimals or 0
                local val  = math.clamp(_saved(flag, cfg.Default or sMin), sMin, sMax)

                local SlF = New("Frame", {Size=UDim2.new(1,0,0,52), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, SlF)
                New("TextLabel", {Size=UDim2.new(1,-80,0,20), Position=UDim2.new(0,10,0,8), BackgroundTransparency=1, Text=cfg.Title or "Slider", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, SlF)
                local VL = New("TextLabel", {Size=UDim2.new(0,70,0,20), Position=UDim2.new(1,-78,0,8), BackgroundTransparency=1, Text=tostring(val)..suf, TextColor3=Theme.Accent, TextSize=12, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Right, ZIndex=5}, SlF)
                local Trk = New("Frame", {Size=UDim2.new(1,-20,0,5), Position=UDim2.new(0,10,0,36), BackgroundColor3=Theme.Divider, BorderSizePixel=0, ZIndex=5}, SlF)
                New("UICorner", {CornerRadius=UDim.new(0,3)}, Trk)
                local p0   = (val-sMin)/(sMax-sMin)
                local Fill = New("Frame", {Size=UDim2.new(p0,0,1,0), BackgroundColor3=Theme.Accent, BorderSizePixel=0, ZIndex=6}, Trk)
                New("UICorner", {CornerRadius=UDim.new(0,3)}, Fill)
                local Thumb = New("Frame", {Size=UDim2.new(0,13,0,13), AnchorPoint=Vector2.new(0.5,0.5), Position=UDim2.new(p0,0,0.5,0), BackgroundColor3=Color3.new(1,1,1), BorderSizePixel=0, ZIndex=7}, Trk)
                New("UICorner", {CornerRadius=UDim.new(0,7)}, Thumb)
                New("UIStroke", {Color=Theme.Accent, Thickness=2}, Thumb)
                local dragging = false
                local hit = New("TextButton", {Size=UDim2.new(1,0,0,52), BackgroundTransparency=1, Text="", ZIndex=8}, SlF)
                hit.InputBegan:Connect(function(i)  if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=true  end end)
                hit.InputEnded:Connect(function(i)  if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
                local function Round(n, d) local m = 10^d; return math.floor(n*m+0.5)/m end
                local function SetVal(v, fire)
                    val = math.clamp(Round(v, dec), sMin, sMax)
                    local p = (val-sMin)/(sMax-sMin)
                    Tween(Fill,  {Size=UDim2.new(p,0,1,0)},   0.05)
                    Tween(Thumb, {Position=UDim2.new(p,0,0.5,0)}, 0.05)
                    VL.Text = tostring(val)..suf
                    if fire ~= false then if flag then _autoSave(flag, val) end; task.spawn(cb, val) end
                end
                UIS.InputChanged:Connect(function(i)
                    if dragging and i.UserInputType==Enum.UserInputType.MouseMovement then
                        local p = math.clamp((i.Position.X-Trk.AbsolutePosition.X)/Trk.AbsoluteSize.X, 0, 1)
                        SetVal(sMin + p*(sMax-sMin))
                    end
                end)
                local sObj = {}
                function sObj:Set(v) SetVal(v, false) end
                function sObj:Get() return val end
                if flag then NightLib.Flags[flag] = sObj end
                return sObj
            end

            function SO:CreateDropdown(cfg)
                cfg = cfg or {}
                local flag     = cfg.Flag
                local cb       = cfg.Callback or function() end
                local opts     = cfg.Options or {}
                local multi    = cfg.MultiSelect or false
                local val      = _saved(flag, cfg.Default or (multi and {} or opts[1]))
                local open     = false
                local selected = multi and (type(val)=="table" and val or {}) or nil

                local DF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=5, ClipsDescendants=false, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, DF)
                New("TextLabel", {Size=UDim2.new(0.6,0,1,0), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Dropdown", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=6}, DF)

                local displayText = multi and (#selected>0 and table.concat(selected,", ") or "None") or tostring(val)
                local VBtn = New("TextButton", {Size=UDim2.new(0,110,0,24), Position=UDim2.new(1,-118,0.5,-12), BackgroundColor3=Theme.Background, Text=displayText.." â–¾", TextColor3=Theme.Accent, TextSize=11, Font=Enum.Font.GothamBold, TextTruncate=Enum.TextTruncate.AtEnd, ZIndex=6}, DF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, VBtn)

                local maxVis = math.min(#opts, 5)
                local DDL = New("Frame", {Size=UDim2.new(0,110,0,maxVis*28+6), Position=UDim2.new(1,-118,1,4), BackgroundColor3=Theme.Panel, BorderSizePixel=0, Visible=false, ZIndex=20, ClipsDescendants=true}, DF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, DDL)
                New("UIStroke", {Color=Theme.Divider, Thickness=1}, DDL)
                local DDS = New("ScrollingFrame", {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, ScrollBarThickness=2, ZIndex=21, CanvasSize=UDim2.new(0,0,0,#opts*28)}, DDL)
                New("UIListLayout", {SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,0)}, DDS)
                New("UIPadding", {PaddingTop=UDim.new(0,3), PaddingBottom=UDim.new(0,3)}, DDS)

                local optBtns = {}
                local function isSelected(o)
                    if multi then for _, v in ipairs(selected) do if v==o then return true end end return false
                    else return val==o end
                end
                local function updateDisplay()
                    if multi then VBtn.Text=(#selected>0 and table.concat(selected,", ") or "None").." â–¾"
                    else VBtn.Text=tostring(val).." â–¾" end
                end

                for _, opt in ipairs(opts) do
                    local sel = isSelected(opt)
                    local OB = New("TextButton", {Size=UDim2.new(1,0,0,28), BackgroundTransparency=sel and 0.7 or 1, BackgroundColor3=Theme.Accent, Text=(multi and (sel and "âœ“ " or "  ") or "")..tostring(opt), TextColor3=sel and Theme.TextPrimary or Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, ZIndex=22}, DDS)
                    optBtns[opt] = OB
                    OB.MouseEnter:Connect(function() Tween(OB, {BackgroundTransparency=0.85, TextColor3=Theme.TextPrimary}, 0.1) end)
                    OB.MouseLeave:Connect(function() Tween(OB, {BackgroundTransparency=isSelected(opt) and 0.7 or 1, TextColor3=isSelected(opt) and Theme.TextPrimary or Theme.TextSecondary}, 0.1) end)
                    OB.MouseButton1Click:Connect(function()
                        if multi then
                            local found = false
                            for i, v in ipairs(selected) do if v==opt then table.remove(selected, i); found=true; break end end
                            if not found then table.insert(selected, opt) end
                            local s = isSelected(opt)
                            OB.Text = (s and "âœ“ " or "  ")..tostring(opt)
                            Tween(OB, {BackgroundTransparency=s and 0.7 or 1, TextColor3=s and Theme.TextPrimary or Theme.TextSecondary}, 0.1)
                            if flag then _autoSave(flag, selected) end
                            task.spawn(cb, selected)
                        else
                            val = opt
                            for o, b in pairs(optBtns) do
                                Tween(b, {BackgroundTransparency=o==opt and 0.7 or 1, TextColor3=o==opt and Theme.TextPrimary or Theme.TextSecondary}, 0.1)
                            end
                            DDL.Visible = false; open = false
                            if flag then _autoSave(flag, val) end
                            task.spawn(cb, opt)
                        end
                        updateDisplay()
                    end)
                end

                VBtn.MouseButton1Click:Connect(function() open = not open; DDL.Visible = open end)

                local dObj = {}
                function dObj:Set(v)
                    if multi then selected = type(v)=="table" and v or {v}
                    else val = v end
                    updateDisplay()
                    for o, b in pairs(optBtns) do
                        local s = isSelected(o)
                        b.Text = (multi and (s and "âœ“ " or "  ") or "")..tostring(o)
                        Tween(b, {BackgroundTransparency=s and 0.7 or 1, TextColor3=s and Theme.TextPrimary or Theme.TextSecondary}, 0.1)
                    end
                end
                function dObj:Get() return multi and selected or val end
                function dObj:Refresh(newOpts)
                    opts = newOpts
                    for _, b in pairs(optBtns) do b:Destroy() end
                    optBtns = {}
                    for _, opt in ipairs(newOpts) do
                        local sel = isSelected(opt)
                        local OB = New("TextButton", {Size=UDim2.new(1,0,0,28), BackgroundTransparency=sel and 0.7 or 1, BackgroundColor3=Theme.Accent, Text=(multi and (sel and "âœ“ " or "  ") or "")..tostring(opt), TextColor3=sel and Theme.TextPrimary or Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, ZIndex=22}, DDS)
                        optBtns[opt] = OB
                    end
                    DDS.CanvasSize = UDim2.new(0,0,0,#newOpts*28)
                    DDL.Size = UDim2.new(0,110,0,math.min(#newOpts,5)*28+6)
                end
                if flag then NightLib.Flags[flag] = dObj end
                return dObj
            end

            function SO:CreateColorPicker(cfg)
                cfg = cfg or {}
                local flag = cfg.Flag
                local cb   = cfg.Callback or function() end
                local cpv  = _saved(flag, cfg.Default or Color3.fromRGB(255,100,100))
                local expanded = false

                local CPF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, ClipsDescendants=true, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, CPF)
                New("TextLabel", {Size=UDim2.new(1,-60,0,36), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Color", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, CPF)
                local Prev = New("TextButton", {Size=UDim2.new(0,28,0,20), Position=UDim2.new(1,-38,0.5,-10), BackgroundColor3=cpv, BorderSizePixel=0, Text="", ZIndex=5}, CPF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, Prev)
                New("UIStroke", {Color=Theme.Divider, Thickness=1}, Prev)
                local EP = New("Frame", {Size=UDim2.new(1,-20,0,120), Position=UDim2.new(0,10,0,42), BackgroundTransparency=1, ZIndex=5}, CPF)
                local chs  = {{"R",Color3.fromRGB(220,60,60)},{"G",Color3.fromRGB(60,200,60)},{"B",Color3.fromRGB(60,100,220)}}
                local vals = {math.floor(cpv.R*255), math.floor(cpv.G*255), math.floor(cpv.B*255)}
                for i, ch in ipairs(chs) do
                    local y = (i-1)*36
                    New("TextLabel", {Size=UDim2.new(0,14,0,20), Position=UDim2.new(0,0,0,y+8), BackgroundTransparency=1, Text=ch[1], TextColor3=ch[2], TextSize=11, Font=Enum.Font.GothamBold, ZIndex=6}, EP)
                    local chT = New("Frame", {Size=UDim2.new(1,-50,0,5), Position=UDim2.new(0,20,0,y+16), BackgroundColor3=Theme.Divider, ZIndex=6}, EP)
                    New("UICorner", {CornerRadius=UDim.new(0,3)}, chT)
                    local chF = New("Frame", {Size=UDim2.new(vals[i]/255,0,1,0), BackgroundColor3=ch[2], ZIndex=7}, chT)
                    New("UICorner", {CornerRadius=UDim.new(0,3)}, chF)
                    local chV = New("TextLabel", {Size=UDim2.new(0,28,0,20), Position=UDim2.new(1,-28,0,y+7), BackgroundTransparency=1, Text=tostring(vals[i]), TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.Gotham, ZIndex=6}, EP)
                    local drag = false
                    local hb = New("TextButton", {Size=UDim2.new(1,-50,0,22), Position=UDim2.new(0,20,0,y+7), BackgroundTransparency=1, Text="", ZIndex=8}, EP)
                    hb.InputBegan:Connect(function(inp) if inp.UserInputType==Enum.UserInputType.MouseButton1 then drag=true  end end)
                    hb.InputEnded:Connect(function(inp) if inp.UserInputType==Enum.UserInputType.MouseButton1 then drag=false end end)
                    UIS.InputChanged:Connect(function(inp)
                        if drag and inp.UserInputType==Enum.UserInputType.MouseMovement then
                            local p = math.clamp((inp.Position.X-chT.AbsolutePosition.X)/chT.AbsoluteSize.X, 0, 1)
                            vals[i] = math.floor(p*255)
                            Tween(chF, {Size=UDim2.new(p,0,1,0)}, 0.05)
                            chV.Text = tostring(vals[i])
                            cpv = Color3.fromRGB(vals[1], vals[2], vals[3])
                            Tween(Prev, {BackgroundColor3=cpv}, 0.05)
                            if flag then _autoSave(flag, cpv) end
                            task.spawn(cb, cpv)
                        end
                    end)
                end
                Prev.MouseButton1Click:Connect(function()
                    expanded = not expanded
                    Tween(CPF, {Size=UDim2.new(1,0,0,expanded and 170 or 36)}, 0.25)
                end)
                local cpObj = {}
                function cpObj:Set(col)
                    cpv = col; vals = {math.floor(col.R*255), math.floor(col.G*255), math.floor(col.B*255)}
                    Tween(Prev, {BackgroundColor3=col}, 0.15)
                end
                function cpObj:Get() return cpv end
                if flag then NightLib.Flags[flag] = cpObj end
                return cpObj
            end

            function SO:CreateInput(cfg)
                cfg = cfg or {}
                local flag = cfg.Flag
                local cb   = cfg.Callback or function() end
                local val  = tostring(_saved(flag, cfg.Default or ""))

                local IF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, IF)
                New("TextLabel", {Size=UDim2.new(0.38,0,1,0), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Input", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, IF)
                local IB = New("TextBox", {Size=UDim2.new(0.58,0,0,24), Position=UDim2.new(0.4,0,0.5,-12), BackgroundColor3=Theme.Background, Text=val, PlaceholderText=cfg.Placeholder or "Type here...", TextColor3=Theme.TextPrimary, PlaceholderColor3=Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, ZIndex=5, ClearTextOnFocus=false}, IF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, IB)
                New("UIPadding", {PaddingLeft=UDim.new(0,8), PaddingRight=UDim.new(0,8)}, IB)
                IB.Focused:Connect(function()
                    Tween(IB, {BackgroundColor3=Theme.Panel}, 0.1)
                    New("UIStroke", {Color=Theme.Accent, Thickness=1, Parent=IB})
                end)
                IB.FocusLost:Connect(function(enter)
                    Tween(IB, {BackgroundColor3=Theme.Background}, 0.1)
                    local s = IB:FindFirstChildWhichIsA("UIStroke"); if s then s:Destroy() end
                    if cfg.FireOnChange or enter then
                        if flag then _autoSave(flag, IB.Text) end
                        task.spawn(cb, IB.Text)
                    end
                end)
                if cfg.FireOnChange then
                    IB:GetPropertyChangedSignal("Text"):Connect(function()
                        task.spawn(cb, IB.Text)
                    end)
                end
                local iObj = {}
                function iObj:Set(v) IB.Text = tostring(v) end
                function iObj:Get() return IB.Text end
                if flag then NightLib.Flags[flag] = iObj end
                return iObj
            end

            function SO:CreateKeybind(cfg)
                cfg = cfg or {}
                local flag    = cfg.Flag
                local cb      = cfg.Callback or function() end
                local val     = _saved(flag, cfg.Default or Enum.KeyCode.Unknown)
                local binding = false

                local KF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, KF)
                New("TextLabel", {Size=UDim2.new(1,-120,1,0), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Keybind", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, KF)
                local KB = New("TextButton", {Size=UDim2.new(0,90,0,24), Position=UDim2.new(1,-98,0.5,-12), BackgroundColor3=Theme.Background, Text=tostring(val.Name), TextColor3=Theme.Accent, TextSize=11, Font=Enum.Font.GothamBold, ZIndex=5}, KF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, KB)

                KB.MouseButton1Click:Connect(function()
                    if binding then return end
                    binding = true
                    KB.Text = "..."
                    KB.TextColor3 = Theme.AccentAlt
                    local conn
                    conn = UIS.InputBegan:Connect(function(i, gpe)
                        if gpe then return end
                        if i.UserInputType == Enum.UserInputType.Keyboard then
                            val = i.KeyCode
                            KB.Text = i.KeyCode.Name
                            KB.TextColor3 = Theme.Accent
                            binding = false
                            conn:Disconnect()
                            if flag then _autoSave(flag, tostring(val.Name)) end
                            task.spawn(cb, val)
                        end
                    end)
                end)

                if cfg.ActivateOnPress then
                    UIS.InputBegan:Connect(function(i, gpe)
                        if not gpe and not binding and i.KeyCode == val then
                            task.spawn(cfg.ActivateOnPress)
                        end
                    end)
                end

                local kObj = {}
                function kObj:Set(k)
                    val = k
                    KB.Text = typeof(k)=="EnumItem" and k.Name or tostring(k)
                end
                function kObj:Get() return val end
                if flag then NightLib.Flags[flag] = kObj end
                return kObj
            end

            function SO:CreateMultiButton(cfg)
                cfg = cfg or {}
                local btns = cfg.Buttons or {}
                local MBF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, MBF)
                New("UIListLayout", {FillDirection=Enum.FillDirection.Horizontal, HorizontalAlignment=Enum.HorizontalAlignment.Center, VerticalAlignment=Enum.VerticalAlignment.Center, SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,6)}, MBF)
                New("UIPadding", {PaddingLeft=UDim.new(0,8), PaddingRight=UDim.new(0,8)}, MBF)
                for i, b in ipairs(btns) do
                    local BB = New("TextButton", {Size=UDim2.new(1/#btns,-8,0,24), BackgroundColor3=Theme.Background, Text=b.Title or "Btn", TextColor3=Theme.TextPrimary, TextSize=12, Font=Enum.Font.GothamBold, ZIndex=5, LayoutOrder=i}, MBF)
                    New("UICorner", {CornerRadius=UDim.new(0,5)}, BB)
                    BB.MouseEnter:Connect(function() Tween(BB, {BackgroundColor3=Theme.Divider}, 0.1) end)
                    BB.MouseLeave:Connect(function() Tween(BB, {BackgroundColor3=Theme.Background}, 0.1) end)
                    BB.MouseButton1Click:Connect(function()
                        Tween(BB, {BackgroundColor3=Theme.Accent}, 0.05); task.wait(0.1)
                        Tween(BB, {BackgroundColor3=Theme.Background}, 0.15)
                        task.spawn(b.Callback or function() end)
                    end)
                end
            end

            function SO:CreateProgressBar(cfg)
                cfg = cfg or {}
                local val  = math.clamp(cfg.Default or 0, 0, 100)
                local suf  = cfg.Suffix or "%"

                local PF = New("Frame", {Size=UDim2.new(1,0,0,46), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, PF)
                New("TextLabel", {Size=UDim2.new(1,-80,0,20), Position=UDim2.new(0,10,0,6), BackgroundTransparency=1, Text=cfg.Title or "Progress", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, PF)
                local VL = New("TextLabel", {Size=UDim2.new(0,70,0,20), Position=UDim2.new(1,-78,0,6), BackgroundTransparency=1, Text=tostring(val)..suf, TextColor3=Theme.Accent, TextSize=12, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Right, ZIndex=5}, PF)
                local Trk = New("Frame", {Size=UDim2.new(1,-20,0,6), Position=UDim2.new(0,10,0,30), BackgroundColor3=Theme.Divider, BorderSizePixel=0, ZIndex=5}, PF)
                New("UICorner", {CornerRadius=UDim.new(0,3)}, Trk)
                local Fill = New("Frame", {Size=UDim2.new(val/100,0,1,0), BackgroundColor3=cfg.Color or Theme.Accent, BorderSizePixel=0, ZIndex=6}, Trk)
                New("UICorner", {CornerRadius=UDim.new(0,3)}, Fill)

                local pObj = {}
                function pObj:Set(v)
                    val = math.clamp(v, 0, 100)
                    Tween(Fill, {Size=UDim2.new(val/100,0,1,0)}, 0.3)
                    VL.Text = tostring(math.floor(val))..suf
                end
                function pObj:Get() return val end
                return pObj
            end

            function SO:CreateParagraph(cfg)
                cfg = cfg or {}
                local titleH = cfg.Title and 20 or 0
                local approxLines = math.ceil(#(cfg.Content or "") / 55)
                local contentH = math.max(approxLines * 16, 20)
                local PG = New("Frame", {Size=UDim2.new(1,0,0,titleH+contentH+20), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, PG)
                New("UIPadding", {PaddingTop=UDim.new(0,8), PaddingBottom=UDim.new(0,8), PaddingLeft=UDim.new(0,10), PaddingRight=UDim.new(0,10)}, PG)
                if cfg.Title then
                    New("TextLabel", {Size=UDim2.new(1,0,0,titleH), BackgroundTransparency=1, Text=cfg.Title, TextColor3=Theme.Accent, TextSize=12, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, PG)
                end
                local CL = New("TextLabel", {Size=UDim2.new(1,0,0,contentH+8), Position=UDim2.new(0,0,0,titleH+2), BackgroundTransparency=1, Text=cfg.Content or "", TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.Gotham, TextWrapped=true, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, PG)
                local pObj = {}
                function pObj:Set(t, c)
                    if t then CL.Text = t end
                end
                function pObj:Get() return CL.Text end
                return pObj
            end

            function SO:CreateAccordion(cfg)
                cfg = cfg or {}
                local expanded = cfg.Default or false
                local items = cfg.Items or {}

                local AF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, ClipsDescendants=true, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, AF)
                local Head = New("TextButton", {Size=UDim2.new(1,0,0,36), BackgroundTransparency=1, Text="", ZIndex=5}, AF)
                New("TextLabel", {Size=UDim2.new(1,-40,1,0), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Accordion", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=6}, Head)
                local Arrow = New("TextLabel", {Size=UDim2.new(0,24,1,0), Position=UDim2.new(1,-30,0,0), BackgroundTransparency=1, Text=expanded and "â–²" or "â–¼", TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.GothamBold, ZIndex=6}, Head)

                local itemH = #items * 30
                local IFrame = New("Frame", {Size=UDim2.new(1,-20,0,itemH), Position=UDim2.new(0,10,0,40), BackgroundTransparency=1, ZIndex=5}, AF)
                New("UIListLayout", {SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,4)}, IFrame)
                for _, item in ipairs(items) do
                    local IB = New("TextButton", {Size=UDim2.new(1,0,0,26), BackgroundColor3=Theme.Background, Text=tostring(item.Title or item), TextColor3=Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, ZIndex=6}, IFrame)
                    New("UICorner", {CornerRadius=UDim.new(0,4)}, IB)
                    IB.MouseButton1Click:Connect(function() task.spawn(item.Callback or function() end) end)
                    IB.MouseEnter:Connect(function() Tween(IB, {TextColor3=Theme.TextPrimary}, 0.1) end)
                    IB.MouseLeave:Connect(function() Tween(IB, {TextColor3=Theme.TextSecondary}, 0.1) end)
                end

                local totalH = 36 + (expanded and itemH+10 or 0)
                AF.Size = UDim2.new(1,0,0,totalH)

                Head.MouseButton1Click:Connect(function()
                    expanded = not expanded
                    Arrow.Text = expanded and "â–²" or "â–¼"
                    Tween(AF, {Size=UDim2.new(1,0,0,expanded and 36+itemH+10 or 36)}, 0.25)
                end)
            end

            function SO:CreateRadioGroup(cfg)
                cfg = cfg or {}
                local flag   = cfg.Flag
                local cb     = cfg.Callback or function() end
                local opts   = cfg.Options or {}
                local val    = _saved(flag, cfg.Default or opts[1])

                local RGF = New("Frame", {Size=UDim2.new(1,0,0,#opts*30+10), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, RGF)
                New("UIPadding", {PaddingTop=UDim.new(0,5), PaddingLeft=UDim.new(0,10), PaddingRight=UDim.new(0,10), PaddingBottom=UDim.new(0,5)}, RGF)
                New("UIListLayout", {SortOrder=Enum.SortOrder.LayoutOrder, Padding=UDim.new(0,2)}, RGF)

                if cfg.Title then
                    New("TextLabel", {Size=UDim2.new(1,0,0,20), BackgroundTransparency=1, Text=cfg.Title, TextColor3=Theme.TextSecondary, TextSize=11, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, RGF)
                end

                local dots = {}
                local function selectOpt(o)
                    val = o
                    for opt, d in pairs(dots) do
                        Tween(d.inner, {BackgroundTransparency=opt==val and 0 or 1}, 0.15)
                        Tween(d.label, {TextColor3=opt==val and Theme.TextPrimary or Theme.TextSecondary}, 0.15)
                    end
                    if flag then _autoSave(flag, val) end
                    task.spawn(cb, val)
                end

                for _, opt in ipairs(opts) do
                    local row = New("Frame", {Size=UDim2.new(1,0,0,28), BackgroundTransparency=1, ZIndex=5}, RGF)
                    local outer = New("Frame", {Size=UDim2.new(0,16,0,16), Position=UDim2.new(0,0,0.5,-8), BackgroundColor3=Theme.Divider, BorderSizePixel=0, ZIndex=6}, row)
                    New("UICorner", {CornerRadius=UDim.new(0.5,0)}, outer)
                    New("UIStroke", {Color=Theme.Accent, Thickness=1.5}, outer)
                    local inner = New("Frame", {Size=UDim2.new(0,8,0,8), AnchorPoint=Vector2.new(0.5,0.5), Position=UDim2.new(0.5,0,0.5,0), BackgroundColor3=Theme.Accent, BackgroundTransparency=opt==val and 0 or 1, BorderSizePixel=0, ZIndex=7}, outer)
                    New("UICorner", {CornerRadius=UDim.new(0.5,0)}, inner)
                    local label = New("TextLabel", {Size=UDim2.new(1,-26,1,0), Position=UDim2.new(0,24,0,0), BackgroundTransparency=1, Text=tostring(opt), TextColor3=opt==val and Theme.TextPrimary or Theme.TextSecondary, TextSize=12, Font=Enum.Font.Gotham, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=6}, row)
                    local hitBtn = New("TextButton", {Size=UDim2.new(1,0,1,0), BackgroundTransparency=1, Text="", ZIndex=8}, row)
                    hitBtn.MouseButton1Click:Connect(function() selectOpt(opt) end)
                    dots[opt] = {inner=inner, label=label}
                end

                local rObj = {}
                function rObj:Set(v) selectOpt(v) end
                function rObj:Get() return val end
                if flag then NightLib.Flags[flag] = rObj end
                return rObj
            end

            function SO:CreateSpinner(cfg)
                cfg = cfg or {}
                local flag   = cfg.Flag
                local cb     = cfg.Callback or function() end
                local opts   = cfg.Options or {}
                local idx    = 1
                local savedV = _saved(flag, cfg.Default or opts[1])
                for i, v in ipairs(opts) do if v == savedV then idx = i break end end

                local SpF = New("Frame", {Size=UDim2.new(1,0,0,36), BackgroundColor3=Theme.PanelAlt, BorderSizePixel=0, ZIndex=4, LayoutOrder=NO()}, SF)
                New("UICorner", {CornerRadius=UDim.new(0,6)}, SpF)
                New("TextLabel", {Size=UDim2.new(1,-130,1,0), Position=UDim2.new(0,10,0,0), BackgroundTransparency=1, Text=cfg.Title or "Spinner", TextColor3=Theme.TextPrimary, TextSize=13, Font=Enum.Font.GothamBold, TextXAlignment=Enum.TextXAlignment.Left, ZIndex=5}, SpF)
                local LB = New("TextButton", {Size=UDim2.new(0,24,0,24), Position=UDim2.new(1,-124,0.5,-12), BackgroundColor3=Theme.Background, Text="â€¹", TextColor3=Theme.Accent, TextSize=16, Font=Enum.Font.GothamBold, ZIndex=5}, SpF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, LB)
                local VL = New("TextLabel", {Size=UDim2.new(0,60,0,24), Position=UDim2.new(1,-98,0.5,-12), BackgroundColor3=Theme.Background, BackgroundTransparency=0, Text=tostring(opts[idx] or ""), TextColor3=Theme.TextPrimary, TextSize=11, Font=Enum.Font.Gotham, ZIndex=5}, SpF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, VL)
                local RB = New("TextButton", {Size=UDim2.new(0,24,0,24), Position=UDim2.new(1,-36,0.5,-12), BackgroundColor3=Theme.Background, Text="â€º", TextColor3=Theme.Accent, TextSize=16, Font=Enum.Font.GothamBold, ZIndex=5}, SpF)
                New("UICorner", {CornerRadius=UDim.new(0,5)}, RB)

                local function update()
                    VL.Text = tostring(opts[idx] or "")
                    if flag then _autoSave(flag, opts[idx]) end
                    task.spawn(cb, opts[idx])
                end
                LB.MouseButton1Click:Connect(function() idx = idx > 1 and idx-1 or #opts; update() end)
                RB.MouseButton1Click:Connect(function() idx = idx < #opts and idx+1 or 1; update() end)

                local sObj = {}
                function sObj:Set(v) for i, o in ipairs(opts) do if o==v then idx=i end end VL.Text=tostring(opts[idx] or "") end
                function sObj:Get() return opts[idx] end
                if flag then NightLib.Flags[flag] = sObj end
                return sObj
            end

            function SO:Update(cfg)
                if cfg and cfg.Title then
                    local l = SH:FindFirstChildWhichIsA("TextLabel"); if l then l.Text = cfg.Title end
                end
            end
            function SO:Destroy() SF:Destroy() end
            return SO
        end

        return TO
    end

    MF.Position = UDim2.new(0.5,-340,1.5,0)
    Tween(MF, {Position=UDim2.new(0.5,-340,0.5,-230)}, 0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    return WO
end

return NightLib
